generator client {
  provider        = "prisma-client-js"
  output          = "../src/generated/prisma"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model user {
  id                    Int      @id @default(autoincrement())
  email                 String   @unique
  password              String
  name                  String
  emailVerified         Boolean  @default(false)
  requirePasswordChange Boolean  @default(false)
  createdAt             DateTime @default(now())
  oidcSub               String?  @unique

  mailTokens        mailToken[]
  organizationUsers organizationUser[]
  auditLogs         auditLog[]

  @@map("users")
}

model mailToken {
  id        Int            @id @default(autoincrement())
  userId    Int
  type      MailTokenTypes
  token     String         @unique
  createdAt DateTime       @default(now())
  expiredAt DateTime       @default(now())

  user user @relation(fields: [userId], references: [id])

  @@map("mail_tokens")
}

enum MailTokenTypes {
  EmailVerify
  PasswordReset
}

model organization {
  id   Int    @id @default(autoincrement())
  name String

  events            event[]
  organizationUsers organizationUser[]

  @@map("organizations")
}

model organizationUser {
  id             Int           @id @default(autoincrement())
  organizationId Int
  userId         Int
  role           UserRoleTypes

  organization organization @relation(fields: [organizationId], references: [id])
  user         user         @relation(fields: [userId], references: [id])

  @@unique([organizationId, userId])
  @@map("organization_users")
}

enum UserRoleTypes {
  User
  Admin
}

model event {
  id             Int      @id @default(autoincrement())
  code           String   @unique
  name           String
  organizationId Int
  date           DateTime @default(now())

  organization organization @relation(fields: [organizationId], references: [id])

  circles circle[]

  @@map("events")
}

model circle {
  id          Int               @id @default(autoincrement())
  eventId     Int
  code        String            @unique
  spaceNumber String
  name        String
  status      CircleStatusTypes @default(None)
  updatedAt   DateTime?

  event event @relation(fields: [eventId], references: [id])

  @@map("circles")
}

enum CircleStatusTypes {
  None
  Attend
  Absent
}

model auditLog {
  id        Int      @id @default(autoincrement())
  userId    Int
  action    String
  timestamp DateTime @default(now())
  value1    String?
  value2    String?
  value3    String?

  user user @relation(fields: [userId], references: [id])

  @@map("audit_logs")
}

enum AuditLogActionTypes {
  UserLogin
  PasswordChange
  EmailVerification
  CircleStatusUpdate
}
